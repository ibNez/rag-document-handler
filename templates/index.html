<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Document Handler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-pending { background-color: #ffc107; }
        .status-processing { background-color: #007bff; animation: pulse 1s infinite; }
        .status-chunking { background-color: #17a2b8; animation: pulse 1s infinite; }
        .status-embedding { background-color: #6f42c1; animation: pulse 1s infinite; }
        .status-storing { background-color: #fd7e14; animation: pulse 1s infinite; }
        .status-completed { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .progress-custom {
            height: 4px;
            margin-top: 5px;
        }
        
        .file-card {
            transition: all 0.3s ease;
        }
        
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-database me-2"></i>RAG Document Handler
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-home me-1"></i>Home
                </a>
                <a class="nav-link" href="{{ url_for('search') }}">
                    <i class="fas fa-robot me-1"></i>Ask AI
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Database Statistics -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-database me-2"></i>Database Statistics</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Collection:</strong> {{ collection_stats.name }}
                            </div>
                            <div class="col-md-4">
                                <strong>Documents:</strong> {{ collection_stats.num_entities or 0 }}
                            </div>
                            <div class="col-md-4">
                                <strong>Status:</strong> 
                                {% if collection_stats.indexed %}
                                    <span class="badge bg-success">Indexed</span>
                                {% else %}
                                    <span class="badge bg-warning">Not Indexed</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Accounts -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Email Accounts</h5>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                            <i class="fas fa-plus me-1"></i>Add Account
                        </button>
                    </div>
                    <div class="card-body">
                        {% if email_accounts %}
                        <ul class="list-group">
                            {% for acct in email_accounts %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ acct.name }}</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#editAccountModal{{ acct.name|replace(' ', '_') }}">Edit</button>
                                    <form method="POST" action="{{ url_for('delete_email_account', name=acct.name) }}" class="d-inline" onsubmit="return confirm('Delete this account?')">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                                    </form>
                                </div>
                            </li>

                            <!-- Edit Account Modal -->
                            <div class="modal fade" id="editAccountModal{{ acct.name|replace(' ', '_') }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form method="POST" action="{{ url_for('update_email_account', name=acct.name) }}">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Edit Account</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Name</label>
                                                    <input type="text" class="form-control" name="name" value="{{ acct.name }}" readonly>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">IMAP Host</label>
                                                    <input type="text" class="form-control" name="imap_host" value="{{ acct.imap_host }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">IMAP User</label>
                                                    <input type="text" class="form-control" name="imap_user" value="{{ acct.imap_user }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">IMAP Password</label>
                                                    <input type="password" class="form-control" name="imap_password" value="{{ acct.imap_password }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">IMAP Port</label>
                                                    <input type="number" class="form-control" name="imap_port" value="{{ acct.imap_port }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Mailbox</label>
                                                    <input type="text" class="form-control" name="mailbox" value="{{ acct.mailbox }}" required>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted">No email accounts configured.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Account Modal -->
        <div class="modal fade" id="addAccountModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="POST" action="{{ url_for('add_email_account') }}">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Email Account</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">IMAP Host</label>
                                <input type="text" class="form-control" name="imap_host" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">IMAP User</label>
                                <input type="text" class="form-control" name="imap_user" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">IMAP Password</label>
                                <input type="password" class="form-control" name="imap_password" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">IMAP Port</label>
                                <input type="number" class="form-control" name="imap_port" value="993" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mailbox</label>
                                <input type="text" class="form-control" name="mailbox" value="INBOX" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- File Upload -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Upload Documents</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="file" class="form-control" name="file" 
                                           accept=".pdf,.docx,.doc,.txt,.md" required>
                                    <div class="form-text">
                                        Supported formats: PDF, DOCX, DOC, TXT, MD (Max: 100MB)
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-upload me-1"></i>Upload to Staging
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Staging Files -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Staging Area</h5>
                        <span class="badge bg-secondary">{{ staging_files|length }} files</span>
                    </div>
                    <div class="card-body">
                        {% if staging_files %}
                            <div class="row">
                                {% for file in staging_files %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card file-card h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">
                                                        {% if file.status %}
                                                            <span class="status-indicator status-{{ file.status.status }}"></span>
                                                        {% endif %}
                                                        {{ file.name }}
                                                    </h6>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                                type="button" data-bs-toggle="dropdown">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li>
                                                                <a class="dropdown-item" href="{{ url_for('process_file', filename=file.name) }}">
                                                                    <i class="fas fa-play me-1"></i>Process
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <form method="POST" action="{{ url_for('delete_file_bg', folder='staging', filename=file.name) }}" onsubmit="return confirm('Delete this file?')">
                                                                    <button type="submit" class="dropdown-item text-danger">
                                                                        <i class="fas fa-trash me-1"></i>Delete
                                                                    </button>
                                                                </form>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                
                                                <small class="text-muted">
                                                    Size: {{ "%.1f"|format(file.size / 1024 / 1024) }} MB | 
                                                    Modified: {{ file.modified.strftime('%Y-%m-%d %H:%M') }}
                                                </small>
                                                
                                                {% if file.status %}
                                                    <div class="mt-2">
                                                        <small class="d-block">{{ file.status.message }}</small>
                                                        {% if file.status.progress > 0 %}
                                                            <div class="progress progress-custom">
                                                                <div class="progress-bar bg-success {% if file.status.status in ['queued','processing','chunking','embedding','storing'] %}progress-animated{% endif %}"
                                                                     role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                                                     aria-valuenow="{{ file.status.progress }}"
                                                                     data-initial-progress="{{ file.status.progress }}"
                                                                     style="width: 0%"></div>
                                                            </div>
                                                        {% endif %}
                                                        {% if file.status.chunks_count > 0 %}
                                                            <small class="text-info">Chunks: {{ file.status.chunks_count }}</small>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No files in staging area. Upload documents to get started.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- URL Management -->
        <div id="url-management" class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-link me-2"></i>URL Management</h5>
                    </div>
                    <div class="card-body">
                        <!-- Add URL Form -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <form method="POST" action="{{ url_for('add_url') }}">
                                    <div class="input-group">
                                        <input type="url" name="url" class="form-control" 
                                               placeholder="Enter URL (e.g., https://example.com)" required>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus me-1"></i>Add URL
                                        </button>
                                    </div>
                                </form>
                                <div class="form-text">
                                    Add URLs to keep track of important resources. The title will be automatically extracted from the page.
                                </div>
                            </div>
                        </div>
                        
                        <!-- URL List -->
                        <div id="urlList">
                            {% if urls %}
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 40%">URL</th>
                                                <th style="width: 20%">Robots & Crawl</th>
                                                <th style="width: 20%">Schedule / Times</th>
                                                <th style="width: 10%">Status</th>
                                                <th style="width: 10%" class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for url in urls %}
                                            <tr data-url-row="{{ url.id }}">
                                                <td>
                                                    <div class="d-flex flex-column">
                                                        <div class="d-flex align-items-center">
                                                            <a href="{{ url.url }}" target="_blank" class="text-decoration-none fw-semibold text-truncate" style="max-width: 520px;" title="{{ url.title or url.url }}">
                                                                {{ url.title if url.title else url.url.split('://')[1].split('/')[0] }}
                                                                <i class="fas fa-external-link-alt ms-1 text-muted small"></i>
                                                            </a>
                                                        </div>
                                                        <div class="text-muted small text-truncate" style="max-width: 520px;" title="{{ url.url }}">{{ url.url }}</div>
                                                        {% if url.description %}
                                                            <div class="text-secondary small text-truncate" style="max-width: 520px;" title="{{ url.description }}">{{ url.description }}</div>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="small">
                                                        <span class="badge rounded-pill {{ 'bg-info' if url.crawl_domain else 'bg-secondary' }}">Crawl {{ 'On' if url.crawl_domain else 'Off' }}</span>
                                                        {% if url.ignore_robots %}
                                                            <span class="badge rounded-pill bg-warning text-dark ms-1" title="Robots.txt checks will be skipped for this URL">Robots Ignored</span>
                                                        {% endif %}
                                                        {% if url.robots_allowed is not none %}
                                                            {% if url.robots_allowed %}
                                                                <span class="badge rounded-pill bg-success ms-1" title="robots.txt allows fetching this URL">Allowed</span>
                                                            {% else %}
                                                                <span class="badge rounded-pill bg-danger ms-1" title="robots.txt disallows fetching this URL">Disallowed</span>
                                                            {% endif %}
                                                            {% if url.robots_has_rules %}
                                                                <span class="badge rounded-pill bg-secondary ms-1" title="robots.txt has specific rules or a crawl-delay for this site">Has Rules</span>
                                                            {% endif %}
                                                            {% if url.robots_crawl_delay is not none %}
                                                                <span class="badge rounded-pill bg-secondary ms-1" title="Crawl-delay from robots.txt">Delay {{ '%.1f'|format(url.robots_crawl_delay) }}s</span>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td class="small">
                                                    <div>Every {{ url.refresh_interval_minutes or 1440 }} min</div>
                                                    <div class="text-muted">Last: {{ (url.last_scraped or '')[:16] if url.last_scraped else '—' }}</div>
                                                    <div class="text-muted">Next: {{ (url.next_refresh or '')[:16] if url.next_refresh else '—' }}</div>
                                                </td>
                                                <td>
                                                    {% set up = url_processing_status.get(url.id) if url_processing_status else None %}
                                                    {% if up %}
                                                        <div class="small mb-1">
                                                            <span class="badge bg-info" title="{{ up.message }}">{{ up.status.title() }}</span>
                                                        </div>
                                                        <div class="progress progress-custom">
                                                            <div class="progress-bar bg-success progress-animated"
                                                                 role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                                                 data-url-id="{{ url.id }}"
                                                                 data-initial-progress="{{ up.progress or 0 }}"
                                                                 style="width: 0%"></div>
                                                        </div>
                                                    {% elif url.last_update_status %}
                                                        <span class="badge {% if url.last_update_status == 'updated' %}bg-success{% elif url.last_update_status in ['unchanged','no_content'] %}bg-secondary{% else %}bg-light text-dark{% endif %}">
                                                            {{ url.last_update_status.replace('_', ' ').title() }}
                                                        </span>
                                                    {% else %}
                                                        <span class="text-muted small">—</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end">
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editUrlModal-{{ url.id }}" title="Edit">
                                                            <i class="fas fa-pen"></i>
                                                        </button>
                                                        <form method="POST" action="{{ url_for('ingest_url', url_id=url.id) }}">
                                                            <button type="submit" class="btn btn-outline-primary" title="Refresh now">
                                                                <i class="fas fa-sync"></i>
                                                            </button>
                                                        </form>
                                                        <form method="POST" action="{{ url_for('delete_url_bg', url_id=url.id) }}" onsubmit="return confirm('Are you sure you want to delete this URL and its embeddings?')">
                                                            <button type="submit" class="btn btn-outline-danger" title="Delete">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                            <!-- Edit URL Modal -->
                                            <div class="modal fade" id="editUrlModal-{{ url.id }}" tabindex="-1" aria-labelledby="editUrlLabel-{{ url.id }}" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editUrlLabel-{{ url.id }}">Edit URL Metadata</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form method="POST" action="{{ url_for('update_url', url_id=url.id) }}">
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label class="form-label">Title</label>
                                                            <input type="text" class="form-control" name="title" value="{{ url.title or '' }}" placeholder="Optional title">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Description</label>
                                                            <textarea class="form-control" name="description" rows="3" placeholder="Optional description">{{ url.description or '' }}</textarea>
                                                        </div>
                                                        <div class="mb-1">
                                                            <label class="form-label">Refresh interval (minutes)</label>
                                                            <input type="number" class="form-control" name="refresh_interval_minutes" min="0" step="1" value="{{ url.refresh_interval_minutes if url.refresh_interval_minutes is not none else 1440 }}">
                                                            <div class="form-text">Set 0 to disable auto-refresh. Default is 1440 (24 hours).</div>
                                                        </div>
                                                        <div class="form-check mt-2">
                                                            <input class="form-check-input" type="checkbox" name="crawl_domain" id="crawlDomain-{{ url.id }}" {% if url.crawl_domain %}checked{% endif %}>
                                                            <label class="form-check-label" for="crawlDomain-{{ url.id }}">
                                                                Crawl entire domain
                                                            </label>
                                                            <div class="form-text">If enabled, we will discover and index pages within the same domain, storing each page with its own source URL.</div>
                                                        </div>
                                                        <div class="form-check mt-2">
                                                            <input class="form-check-input" type="checkbox" name="ignore_robots" id="ignoreRobots-{{ url.id }}" {% if url.ignore_robots %}checked{% endif %}>
                                                            <label class="form-check-label" for="ignoreRobots-{{ url.id }}">
                                                                Ignore robots.txt for this URL
                                                            </label>
                                                            <div class="form-text text-warning">Use with caution. This may violate site policies; ensure you have permission to crawl.</div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                            </div>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-link fa-3x mb-3"></i>
                                    <p>No URLs added yet. Add your first URL above.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Uploaded Files -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Processed Documents</h5>
                        <span class="badge bg-success">{{ uploaded_files|length }} files</span>
                    </div>
                    <div class="card-body">
                        {% if uploaded_files %}
                            <div class="row">
                                {% for file in uploaded_files %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card file-card h-100 border-success">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">
                                                        <span class="status-indicator status-completed"></span>
                                                        {{ file.name }}
                                                    </h6>
                                                    <form method="POST" action="{{ url_for('delete_file_bg', folder='uploaded', filename=file.name) }}" onsubmit="return confirm('Delete this file and remove from database?')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                                
                                                <small class="text-muted">
                                                    Size: {{ "%.1f"|format(file.size / 1024 / 1024) }} MB | 
                                                    Processed: {{ file.modified.strftime('%Y-%m-%d %H:%M') }}
                                                </small>
                                                
                                                <div class="mt-2">
                                                    <span class="badge bg-success">In Database</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-database fa-3x mb-3"></i>
                                <p>No documents processed yet. Process files from staging area.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Auto-refresh for processing status -->
    <script>
        function refreshProcessingStatus() {
            const fileCards = document.querySelectorAll('.file-card');
            fileCards.forEach(card => {
                const filename = card.querySelector('.card-title').textContent.trim();
                if (card.querySelector('.status-processing, .status-chunking, .status-embedding, .status-storing')) {
                    fetch(`/status/${encodeURIComponent(filename)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status !== 'not_found') {
                                // Update status indicator
                                const indicator = card.querySelector('.status-indicator');
                                if (indicator) {
                                    indicator.className = `status-indicator status-${data.status}`;
                                }
                                
                                // Update progress and message
                                const messageEl = card.querySelector('small');
                                if (messageEl && data.message) {
                                    messageEl.textContent = data.message;
                                }
                                
                                const progressBar = card.querySelector('.progress-bar');
                                if (progressBar && typeof data.progress === 'number') {
                                    progressBar.style.width = `${data.progress}%`;
                                    progressBar.setAttribute('aria-valuenow', String(data.progress));
                                    // Toggle animation depending on state
                                    if (["queued","processing","chunking","embedding","storing"].includes(data.status)) {
                                        progressBar.classList.add('progress-animated');
                                    } else {
                                        progressBar.classList.remove('progress-animated');
                                    }
                                }
                                
                                // If this card is in a deletion flow, remove it when done
                                if (data.message && data.message.toLowerCase().includes('deletion complete')) {
                                    card.style.transition = 'opacity 200ms ease';
                                    card.style.opacity = '0';
                                    setTimeout(() => card.remove(), 220);
                                    return;
                                }
                                // Only reload when completed/error if the user isn't typing in any input to avoid disrupting URL adds
                                if (data.status === 'completed' || data.status === 'error') {
                                    const focused = document.querySelector('input:focus, textarea:focus, select:focus, [contenteditable="true"]:focus');
                                    if (!focused) {
                                        setTimeout(() => {
                                            const stillFocused = document.querySelector('input:focus, textarea:focus, select:focus, [contenteditable="true"]:focus');
                                            if (!stillFocused) {
                                                location.reload();
                                            }
                                        }, 1000);
                                    }
                                }
                            }
                        })
                        .catch(error => console.error('Status update error:', error));
                }
            });
        }
        
        // Refresh every 2 seconds for processing files
        setInterval(refreshProcessingStatus, 2000);
        // Initialize any progress bars rendered with server-side values
        document.querySelectorAll('.progress-bar[data-initial-progress]').forEach(pb => {
            const init = parseInt(pb.getAttribute('data-initial-progress')) || 0;

                // URL refresh progress polling
                function refreshUrlStatuses() {
                    document.querySelectorAll('.progress-bar[data-url-id]').forEach(pb => {
                        const urlId = pb.getAttribute('data-url-id');
                        fetch(`/url_status/${urlId}`)
                            .then(r => r.json())
                            .then(data => {
                                if (!data) return;
                                if (data.status === 'deleted') {
                                    // Remove the entire row from the table
                                    const row = pb.closest('tr');
                                    if (row) {
                                        row.style.transition = 'opacity 200ms ease';
                                        row.style.opacity = '0';
                                        setTimeout(() => row.remove(), 220);
                                    }
                                    return;
                                }
                                if (data.status === 'not_found') {
                                    // Background task ended; swap progress for final badge without full reload
                                    try {
                                        const td = pb.closest('td');
                                        if (td) {
                                            const statusText = (data.last_update_status || '—').replaceAll('_',' ');
                                            const cls = data.last_update_status === 'updated' ? 'bg-success' : (['unchanged','no_content'].includes(data.last_update_status) ? 'bg-secondary' : 'bg-light text-dark');
                                            td.innerHTML = `<span class="badge ${cls}">${statusText.charAt(0).toUpperCase()+statusText.slice(1)}</span>`;
                                        }
                                        // Also update the Last/Next times in the adjacent column if present
                                        const row = td ? td.closest('tr') : null;
                                        if (row) {
                                            const timesCell = row.children[2];
                                            if (timesCell) {
                                                const lines = timesCell.querySelectorAll('div');
                                                if (lines && lines.length >= 3) {
                                                    // Update Last
                                                    const lastVal = data.last_scraped ? String(data.last_scraped).slice(0,16) : '—';
                                                    lines[1].textContent = `Last: ${lastVal}`;
                                                    // Update Next
                                                    const nextVal = data.next_refresh ? String(data.next_refresh).slice(0,16) : '—';
                                                    lines[2].textContent = `Next: ${nextVal}`;
                                                }
                                            }
                                        }
                                    } catch (e) { /* no-op */ }
                                    return;
                                }
                                const pct = typeof data.progress === 'number' ? data.progress : 0;
                                pb.style.width = `${pct}%`;
                                pb.setAttribute('aria-valuenow', String(pct));
                                if (["queued","processing","chunking","embedding","storing"].includes(data.status)) {
                                    pb.classList.add('progress-animated');
                                } else {
                                    pb.classList.remove('progress-animated');
                                }
                                if (data.status === 'completed' || data.status === 'error') {
                                    // Replace with badge immediately
                                    const td = pb.closest('td');
                                    if (td) {
                                        const s = data.status === 'completed' ? 'updated' : 'error';
                                        const cls = s === 'updated' ? 'bg-success' : 'bg-light text-dark';
                                        td.innerHTML = `<span class="badge ${cls}">${s.charAt(0).toUpperCase()+s.slice(1)}</span>`;
                                    }
                                }
                            })
                            .catch(() => {});
                    });
                }
                setInterval(refreshUrlStatuses, 1500);
                // Initialize URL bars
                refreshUrlStatuses();
            pb.style.width = `${init}%`;
            pb.setAttribute('aria-valuenow', String(init));
            if (init >= 100) {
                pb.classList.remove('progress-animated');
            }
        });
    </script>
</body>
</html>
