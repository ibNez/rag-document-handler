<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Knowledgebase Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-pending { background-color: #ffc107; }
        .status-processing { background-color: #007bff; animation: pulse 1s infinite; }
        .status-chunking { background-color: #17a2b8; animation: pulse 1s infinite; }
        .status-embedding { background-color: #6f42c1; animation: pulse 1s infinite; }
        .status-storing { background-color: #fd7e14; animation: pulse 1s infinite; }
        .status-completed { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .progress-custom {
            height: 4px;
            margin-top: 5px;
        }
        
        .file-card {
            transition: all 0.3s ease;
            position: relative; /* ensure stacking context */
            overflow: visible; /* allow dropdown to extend outside */
            z-index: 1;
        }
        
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 2500; /* lift above neighbors so dropdown fully visible */
        }
        /* Ensure dropdown menus over adjacent cards */
        .file-card .dropdown-menu {
            z-index: 2000;
        }
        .file-card:hover .dropdown-menu, .file-card.show .dropdown-menu {
            z-index: 3000; /* extra on hover/open */
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-database me-2"></i>RAG Knowledgebase Manager
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-home me-1"></i>Home
                </a>
                <a class="nav-link" href="{{ url_for('search') }}">
                    <i class="fas fa-robot me-1"></i>Ask AI
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

    <!-- Knowledgebase Statistics -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <style>
                            .kb-section-title { font-size: .85rem; text-transform: uppercase; letter-spacing: .05em; opacity:.85; margin-bottom:.25rem; }
                            .metric-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(140px,1fr)); gap:.75rem; }
                            .metric-tile { background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); border-radius:.5rem; padding:.6rem .65rem; backdrop-filter:blur(2px); position:relative; }
                            .metric-tile:hover { background:rgba(255,255,255,0.14); }
                            .metric-label { font-size:.65rem; text-transform:uppercase; letter-spacing:.06em; opacity:.75; margin:0 0 .15rem 0; }
                            .metric-value { font-weight:600; font-size:1.05rem; line-height:1.1; }
                            .metric-sub { font-size:.55rem; opacity:.6; margin-top:.15rem; }
                            .status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:4px; }
                            .dot-ok { background:#4ade80; box-shadow:0 0 0 4px rgba(74,222,128,0.15); }
                            .dot-bad { background:#f87171; box-shadow:0 0 0 4px rgba(248,113,113,0.15); }
                            .keywords-wrap { display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.35rem; }
                            .keyword-pill { background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.18); border-radius:2rem; padding:.2rem .6rem; font-size:.6rem; }
                        </style>
                        <div class="row g-3">
                            <div class="col-12 col-lg-6">
                                <div class="kb-section-title">Connections</div>
                                <div class="metric-grid">
                                    <div class="metric-tile">
                                        <div class="metric-label">SQL</div>
                                        <div class="metric-value">
                                            <span class="status-dot {{ 'dot-ok' if sql_status and sql_status.connected else 'dot-bad' }}"></span>
                                            {{ 'Connected' if sql_status and sql_status.connected else 'Unavailable' }}
                                        </div>
                                        {% if sql_status and sql_status.connected and sql_status.version %}
                                            <div class="metric-sub">v{{ sql_status.version }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="metric-tile">
                                        <div class="metric-label">Milvus</div>
                                        <div class="metric-value d-flex align-items-center">
                                            <span class="status-dot {{ 'dot-ok' if milvus_status and milvus_status.connected else 'dot-bad' }}"></span>
                                            <span>{{ 'Connected' if milvus_status and milvus_status.connected else 'Unavailable' }}</span>
                                        </div>
                                        {% if milvus_status and milvus_status.connected and milvus_status.version %}
                                            <div class="metric-sub">v{{ milvus_status.version }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="metric-tile">
                                        <div class="metric-label">Collection</div>
                                        <div class="metric-value">{{ collection_stats.name }}</div>
                                        <div class="metric-sub">{{ collection_stats.num_entities or 0 }} entities</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="kb-section-title">Documents</div>
                                <div class="metric-grid">
                                    <div class="metric-tile"><div class="metric-label">Total Docs</div><div class="metric-value">{{ kb_meta.documents_total }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Avg Words/Doc</div><div class="metric-value">{{ kb_meta.avg_words_per_doc }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Avg Chunks/Doc</div><div class="metric-value">{{ kb_meta.avg_chunks_per_doc }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Median Chunk Chars</div><div class="metric-value">{{ kb_meta.median_chunk_chars }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Embedding Dim</div><div class="metric-value">{{ collection_stats.dim or (config.VECTOR_DIM if config else '') }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Index</div><div class="metric-value">{{ 'Yes' if collection_stats.indexed else 'No' }}</div><div class="metric-sub">Metric {{ collection_stats.metric_type or 'cosine' }}</div></div>
                                </div>
                                {% if kb_meta.top_keywords %}
                                <div class="kb-section-title mt-3">Top Keywords</div>
                                <div class="keywords-wrap">
                                    {% for k in kb_meta.top_keywords %}
                                        <span class="keyword-pill">{{ k }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="kb-section-title">URLs</div>
                                <div class="metric-grid">
                                    <div class="metric-tile"><div class="metric-label">Total URLs</div><div class="metric-value">{{ url_meta.total or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Active</div><div class="metric-value">{{ url_meta.active or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Crawl Domain On</div><div class="metric-value">{{ url_meta.crawl_on or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Robots Ignored</div><div class="metric-value">{{ url_meta.robots_ignored or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Scraped</div><div class="metric-value">{{ url_meta.scraped or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Never Scraped</div><div class="metric-value">{{ url_meta.never_scraped or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Due Now</div><div class="metric-value">{{ url_meta.due_now or 0 }}</div></div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="kb-section-title">Emails</div>
                                <div class="metric-grid">
                                    <div class="metric-tile"><div class="metric-label">Total Accounts</div><div class="metric-value">{{ email_meta.total_accounts or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Due Now</div><div class="metric-value">{{ email_meta.due_now or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Never Synced</div><div class="metric-value">{{ email_meta.never_synced or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Total Emails</div><div class="metric-value">{{ email_meta.total_emails or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">Unique Senders</div><div class="metric-value">{{ email_meta.unique_senders or 0 }}</div></div>
                                    <div class="metric-tile"><div class="metric-label">With Attachments</div><div class="metric-value">{{ email_meta.emails_with_attachments or 0 }}</div></div>
                                    {% if email_meta.avg_emails_per_account > 0 %}
                                    <div class="metric-tile"><div class="metric-label">Avg per Account</div><div class="metric-value">{{ email_meta.avg_emails_per_account }}</div></div>
                                    {% endif %}
                                </div>
                                {% if email_meta.most_active_account %}
                                <div class="kb-section-title mt-3">Most Active Account</div>
                                <div class="keywords-wrap">
                                    <span class="keyword-pill">{{ email_meta.most_active_account }}</span>
                                </div>
                                {% endif %}
                                {% if email_meta.latest_email_date %}
                                <div class="kb-section-title mt-3">Latest Email</div>
                                <div class="metric-sub">{{ email_meta.latest_email_date }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Upload Documents</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="file" class="form-control" name="file" 
                                           accept=".pdf,.docx,.doc,.txt,.md" required>
                                    <div class="form-text">
                                        Supported formats: PDF, DOCX, DOC, TXT, MD (Max: 100MB)
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-upload me-1"></i>Upload to Staging
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Staging Files -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Staging Area</h5>
                        <span class="badge bg-secondary">{{ staging_files|length }} files</span>
                    </div>
                    <div class="card-body">
                        {% if staging_files %}
                            <div class="row">
                                {% for file in staging_files %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card file-card h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">
                                                        {% if file.status %}
                                                            <span class="status-indicator status-{{ file.status.status }}"></span>
                                                        {% endif %}
                                                        {{ file.name }}
                                                    </h6>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                                type="button" data-bs-toggle="dropdown">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li>
                                                                <a class="dropdown-item" href="{{ url_for('process_file', filename=file.name) }}">
                                                                    <i class="fas fa-play me-1"></i>Process
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <form method="POST" action="{{ url_for('delete_file_bg', folder='staging', filename=file.name) }}" onsubmit="return confirm('Delete this file?')">
                                                                    <button type="submit" class="dropdown-item text-danger">
                                                                        <i class="fas fa-trash me-1"></i>Delete
                                                                    </button>
                                                                </form>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                
                                                <small class="text-muted">
                                                    Size: {{ "%.1f"|format(file.size / 1024 / 1024) }} MB | 
                                                    Modified: {{ file.modified.strftime('%Y-%m-%d %H:%M') }}
                                                </small>
                                                
                                                {% if file.status %}
                                                    <div class="mt-2">
                                                        <small class="d-block">{{ file.status.message }}</small>
                                                        {% if file.status.progress > 0 %}
                                                            <div class="progress progress-custom">
                                                                <div class="progress-bar bg-success {% if file.status.status in ['queued','processing','chunking','embedding','storing'] %}progress-animated{% endif %}"
                                                                     role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                                                     aria-valuenow="{{ file.status.progress }}"
                                                                     data-initial-progress="{{ file.status.progress }}"
                                                                     style="width: 0%"></div>
                                                            </div>
                                                        {% endif %}
                                                        {% if file.status.chunks_count > 0 %}
                                                            <small class="text-info">Chunks: {{ file.status.chunks_count }}</small>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No files in staging area. Upload documents to get started.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- URL Management -->
        <div id="url-management" class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-link me-2"></i>URL Management</h5>
                    </div>
                    <div class="card-body">
                        <!-- Add URL Form -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <form method="POST" action="{{ url_for('add_url') }}">
                                    <div class="input-group">
                                        <input type="url" name="url" class="form-control" 
                                               placeholder="Enter URL (e.g., https://example.com)" required>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus me-1"></i>Add URL
                                        </button>
                                    </div>
                                </form>
                                <div class="form-text">
                                    Add URLs to keep track of important resources. The title will be automatically extracted from the page.
                                </div>
                            </div>
                        </div>
                        
                        <!-- URL List -->
                        <div id="urlList">
                            {% if urls %}
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 40%">URL</th>
                                                <th style="width: 20%">Robots & Crawl</th>
                                                <th style="width: 20%">Schedule / Times</th>
                                                <th style="width: 10%">Status</th>
                                                <th style="width: 10%" class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for url in urls %}
                                            <tr data-url-row="{{ url.id }}">
                                                <td>
                                                    <div class="d-flex flex-column">
                                                        <div class="d-flex align-items-center">
                                                            <a href="{{ url.url }}" target="_blank" class="text-decoration-none fw-semibold text-truncate" style="max-width: 520px;" title="{{ url.title or url.url }}">
                                                                {{ url.title if url.title else url.url.split('://')[1].split('/')[0] }}
                                                                <i class="fas fa-external-link-alt ms-1 text-muted small"></i>
                                                            </a>
                                                        </div>
                                                        <div class="text-muted small text-truncate" style="max-width: 520px;" title="{{ url.url }}">{{ url.url }}</div>
                                                        {% if url.description %}
                                                            <div class="text-secondary small text-truncate" style="max-width: 520px;" title="{{ url.description }}">{{ url.description }}</div>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="small">
                                                        <span class="badge rounded-pill {{ 'bg-info' if url.crawl_domain else 'bg-secondary' }}">Crawl {{ 'On' if url.crawl_domain else 'Off' }}</span>
                                                        {% if url.ignore_robots %}
                                                            <span class="badge rounded-pill bg-warning text-dark ms-1" title="Robots.txt checks will be skipped for this URL">Robots Ignored</span>
                                                        {% endif %}
                                                        {% if url.robots_allowed is not none %}
                                                            {% if url.robots_allowed %}
                                                                <span class="badge rounded-pill bg-success ms-1" title="robots.txt allows fetching this URL">Allowed</span>
                                                            {% else %}
                                                                <span class="badge rounded-pill bg-danger ms-1" title="robots.txt disallows fetching this URL">Disallowed</span>
                                                            {% endif %}
                                                            {% if url.robots_has_rules %}
                                                                <span class="badge rounded-pill bg-secondary ms-1" title="robots.txt has specific rules or a crawl-delay for this site">Has Rules</span>
                                                            {% endif %}
                                                            {% if url.robots_crawl_delay is not none %}
                                                                <span class="badge rounded-pill bg-secondary ms-1" title="Crawl-delay from robots.txt">Delay {{ '%.1f'|format(url.robots_crawl_delay) }}s</span>
                                                            {% endif %}
                                                        {% endif %}
                                                        {% if url.snapshot_enabled %}
                                                            <span class="badge rounded-pill bg-primary ms-1" title="Snapshots enabled for this URL"><i class="fas fa-camera me-1"></i>Snapshots On</span>
                                                            {% if url.snapshot_retention_days is not none %}
                                                                <span class="badge rounded-pill bg-light text-dark ms-1" title="Retention days">{{ url.snapshot_retention_days }}d</span>
                                                            {% endif %}
                                                            {% if url.snapshot_max_snapshots is not none %}
                                                                <span class="badge rounded-pill bg-light text-dark ms-1" title="Max snapshots">{{ url.snapshot_max_snapshots }} max</span>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td class="small">
                                                    <div>Every {{ url.refresh_interval_minutes or 1440 }} min</div>
                                                    <div class="text-muted">Last: {{ (url.last_scraped or '')[:16] if url.last_scraped else '—' }}</div>
                                                    <div class="text-muted">Next: {{ (url.next_refresh or '')[:16] if url.next_refresh else '—' }}</div>
                                                </td>
                                                <td>
                                                    {% set up = url_processing_status.get(url.id) if url_processing_status else None %}
                                                    {% if up %}
                                                        <div class="small mb-1">
                                                            <span class="badge bg-info" title="{{ up.message }}">{{ up.status.title() }}</span>
                                                        </div>
                                                        <div class="progress progress-custom">
                                                            <div class="progress-bar bg-success progress-animated"
                                                                 role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                                                 data-url-id="{{ url.id }}"
                                                                 data-initial-progress="{{ up.progress or 0 }}"
                                                                 style="width: 0%"></div>
                                                        </div>
                                                    {% elif url.last_update_status %}
                                                        <span class="badge {% if url.last_update_status == 'updated' %}bg-success{% elif url.last_update_status in ['unchanged','no_content'] %}bg-secondary{% else %}bg-light text-dark{% endif %}">
                                                            {{ url.last_update_status.replace('_', ' ').title() }}
                                                        </span>
                                                    {% else %}
                                                        <span class="text-muted small">—</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end">
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary action-btn" data-bs-toggle="modal" data-bs-target="#editUrlModal-{{ url.id }}" title="Edit">
                                                            <i class="fas fa-pen"></i>
                                                        </button>
                                                        <form method="POST" action="{{ url_for('ingest_url', url_id=url.id) }}">
                                                            <button type="submit" class="btn btn-outline-primary action-btn" title="Refresh now">
                                                                <i class="fas fa-sync"></i>
                                                            </button>
                                                        </form>
                                                        <form method="POST" action="{{ url_for('delete_url_bg', url_id=url.id) }}" onsubmit="return confirm('Are you sure you want to delete this URL and its embeddings?')">
                                                            <button type="submit" class="btn btn-outline-danger action-btn" title="Delete">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                            <!-- Edit URL Modal -->
                                            <div class="modal fade" id="editUrlModal-{{ url.id }}" tabindex="-1" aria-labelledby="editUrlLabel-{{ url.id }}" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editUrlLabel-{{ url.id }}">Edit URL Metadata</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form method="POST" action="{{ url_for('update_url', url_id=url.id) }}">
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label class="form-label">Title</label>
                                                            <input type="text" class="form-control" name="title" value="{{ url.title or '' }}" placeholder="Optional title">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Description</label>
                                                            <textarea class="form-control" name="description" rows="3" placeholder="Optional description">{{ url.description or '' }}</textarea>
                                                        </div>
                                                        <div class="mb-1">
                                                            <label class="form-label">Refresh interval (minutes)</label>
                                                            <input type="number" class="form-control" name="refresh_interval_minutes" min="0" step="1" value="{{ url.refresh_interval_minutes if url.refresh_interval_minutes is not none else 1440 }}">
                                                            <div class="form-text">Set 0 to disable auto-refresh. Default is 1440 (24 hours).</div>
                                                        </div>
                                                        <div class="form-check mt-2">
                                                            <input class="form-check-input" type="checkbox" name="crawl_domain" id="crawlDomain-{{ url.id }}" {% if url.crawl_domain %}checked{% endif %}>
                                                            <label class="form-check-label" for="crawlDomain-{{ url.id }}">
                                                                Crawl entire domain
                                                            </label>
                                                            <div class="form-text">If enabled, we will discover and index pages within the same domain, storing each page with its own source URL.</div>
                                                        </div>
                                                        <div class="form-check mt-2">
                                                            <input class="form-check-input" type="checkbox" name="ignore_robots" id="ignoreRobots-{{ url.id }}" {% if url.ignore_robots %}checked{% endif %}>
                                                            <label class="form-check-label" for="ignoreRobots-{{ url.id }}">
                                                                Ignore robots.txt for this URL
                                                            </label>
                                                            <div class="form-text text-warning">Use with caution. This may violate site policies; ensure you have permission to crawl.</div>
                                                        </div>
                                                        <hr>
                                                        <div class="mb-2">
                                                            <label class="form-label mb-1">Snapshots</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" name="snapshot_enabled" id="snapshotEnabled-{{ url.id }}" {% if url.snapshot_enabled %}checked{% endif %}>
                                                                <label class="form-check-label" for="snapshotEnabled-{{ url.id }}">
                                                                    Enable point-in-time snapshots for this URL (Suggested for sites that change a lot.)
                                                                </label>
                                                            </div>
                                                            <div class="row mt-2">
                                                                <div class="col-md-6 mb-2">
                                                                    <label class="form-label">Retention (days)</label>
                                                                    <input type="number" class="form-control" name="snapshot_retention_days" min="0" step="1" value="{{ url.snapshot_retention_days if url.snapshot_retention_days is not none else '' }}" placeholder="Unlimited">
                                                                    <div class="form-text">Leave blank for unlimited days.</div>
                                                                </div>
                                                                <div class="col-md-6 mb-2">
                                                                    <label class="form-label">Max snapshots</label>
                                                                    <input type="number" class="form-control" name="snapshot_max_snapshots" min="0" step="1" value="{{ url.snapshot_max_snapshots if url.snapshot_max_snapshots is not none else '' }}" placeholder="Unlimited">
                                                                    <div class="form-text">Leave blank for unlimited copies.</div>
                                                                </div>
                                                            </div>
                                                            <div class="form-text">Artifacts will be stored under {{ config.SNAPSHOT_DIR if config else 'uploaded/snapshots' }}.</div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                            </div>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-link fa-3x mb-3"></i>
                                    <p>No URLs added yet. Add your first URL above.</p>
                                </div>
                            {% endif %}
        </div>
        </div>
        </div>
        </div>
        </div>

        <!-- Email Accounts -->
        <div id="email-accounts" class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Email Accounts</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addEmailAccountModal">
                            <i class="fas fa-plus me-1"></i>Add
                        </button>
                    </div>
                    <div class="card-body">
                        {% if email_accounts %}
                            <div class="table-responsive">
                                <table class="table table-hover table-sm align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Display Name</th>
                                            <th>Server Type</th>
                                            <th>Server</th>
                                            <th>Email Address</th>
                                            <th>Schedule / Time</th>
                                            <th>Status</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for acct in email_accounts %}
                                        <tr>
                                            <td>{{ acct.account_name }}</td>
                                            <td>{{ {'imap': 'IMAP', 'gmail': 'Gmail', 'exchange': 'Exchange'}.get(acct.server_type, acct.server_type) }}</td>
                                            <td>{{ acct.server }}:{{ acct.port }}</td>
                                            <td>{{ acct.email_address }}</td>
                                            <td class="small">
                                                <div>Every {{ acct.refresh_interval_minutes or config.EMAIL_DEFAULT_REFRESH_MINUTES }} min</div>
                                                <div class="text-muted">Last: {{ (acct.last_synced or '')[:16] if acct.last_synced else '—' }}</div>
                                                <div class="text-muted">Next: {{ (acct.next_run or '')[:16] if acct.next_run else '—' }}</div>
                                            </td>
                                            <td>
                                                {% set up = email_processing_status.get(acct.id) if email_processing_status else None %}
                                                {% if up %}
                                                    <div class="small mb-1">
                                                        <span class="badge bg-info" title="{{ up.message }}">{{ up.status.title() }}</span>
                                                    </div>
                                                    <div class="progress progress-custom">
                                                        <div class="progress-bar bg-success progress-animated"
                                                             role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                                             data-email-id="{{ acct.id }}"
                                                             data-initial-progress="{{ up.progress or 0 }}"
                                                             style="width: 0%"></div>
                                                    </div>
                                                {% elif acct.last_update_status %}
                                                    {% set status_text = acct.last_update_status %}
                                                    <span class="badge {% if status_text.startswith('error') %}bg-light text-dark{% else %}bg-success{% endif %}">{{ status_text }}</span>
                                                {% else %}
                                                    <span class="text-muted small">—</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-secondary action-btn edit-account-btn"
                                                            data-bs-toggle="modal" data-bs-target="#editEmailAccountModal"
                                                            data-action="{{ url_for('update_email_account', account_id=acct.id) }}"
                                                            data-id="{{ acct.id }}"
                                                            data-name="{{ acct.account_name }}"
                                                            data-server="{{ acct.server }}"
                                                            data-email="{{ acct.email_address }}"
                                                            data-port="{{ acct.port }}"
                                                            data-mailbox="{{ acct.mailbox or '' }}"
                                                            data-batch="{{ acct.batch_limit or '' }}"
                                                            data-interval="{{ acct.refresh_interval_minutes or '' }}"
                                                            data-ssl="{{ '1' if acct.use_ssl else '0' }}"
                                                            data-type="{{ acct.server_type }}"
                                                            title="Edit">
                                                        <i class="fas fa-pen"></i>
                                                    </button>
                                                    <form method="POST" action="{{ url_for('refresh_email_account', account_id=acct.id) }}">
                                                        <button type="submit" class="btn btn-outline-primary action-btn" title="Refresh now">
                                                            <i class="fas fa-sync"></i>
                                                        </button>
                                                    </form>
                                                    <button type="button" class="btn btn-outline-danger action-btn delete-account-btn"
                                                            data-bs-toggle="modal" data-bs-target="#deleteEmailAccountModal"
                                                            data-action="{{ url_for('delete_email_account', account_id=acct.id) }}"
                                                            data-name="{{ acct.account_name }}"
                                                            title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-envelope-open fa-3x mb-3"></i>
                                <p>No email accounts configured.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Email Account Modal -->
        <div class="modal fade" id="addEmailAccountModal" tabindex="-1" aria-labelledby="addEmailAccountLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form method="POST" action="{{ url_for('add_email_account') }}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addEmailAccountLabel">Add Email Account</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Display Name</label>
                                <input type="text" class="form-control" name="account_name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Server Type</label>
                                <select class="form-select" name="server_type" required>
                                    <option value="imap">IMAP</option>
                                    <option value="gmail">Gmail</option>
                                    <option value="exchange">Exchange</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Server</label>
                                <input type="text" class="form-control" name="server" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="text" class="form-control" name="email_address" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" name="password" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Port</label>
                                    <input type="number" class="form-control" name="port" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mailbox</label>
                                    <input type="text" class="form-control" name="mailbox" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Batch Limit</label>
                                    <input type="number" class="form-control" name="batch_limit" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Refresh interval (minutes)</label>
                                    <input type="number" class="form-control" name="refresh_interval_minutes" value="{{ config.EMAIL_DEFAULT_REFRESH_MINUTES }}" required>
                                </div>
                            </div>
                            <div class="mb-3 form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="use_ssl" id="addUseSSL" value="1">
                                <label class="form-check-label" for="addUseSSL">Use SSL</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Email Account Modal -->
        <div class="modal fade" id="editEmailAccountModal" tabindex="-1" aria-labelledby="editEmailAccountLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form method="POST" id="editEmailAccountForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editEmailAccountLabel">Edit Email Account</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="account_id" id="editAccountId">
                            <div class="mb-3">
                                <label class="form-label">Display Name</label>
                                <input type="text" class="form-control" name="account_name" id="editAccountName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Server Type</label>
                                <select class="form-select" name="server_type" id="editServerType" required>
                                    <option value="imap">IMAP</option>
                                    <option value="gmail">Gmail</option>
                                    <option value="exchange">Exchange</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Server</label>
                                <input type="text" class="form-control" name="server" id="editServer" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="text" class="form-control" name="email_address" id="editEmailAddress" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password (leave blank to keep current)</label>
                                <input type="password" class="form-control" name="password" id="editPassword">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Port</label>
                                    <input type="number" class="form-control" name="port" id="editPort" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mailbox</label>
                                    <input type="text" class="form-control" name="mailbox" id="editMailbox" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Batch Limit</label>
                                    <input type="number" class="form-control" name="batch_limit" id="editBatchLimit" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Refresh interval (minutes)</label>
                                    <input type="number" class="form-control" name="refresh_interval_minutes" id="editRefreshInterval" required>
                                </div>
                            </div>
                            <div class="mb-3 form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="use_ssl" id="editUseSSL" value="1">
                                <label class="form-check-label" for="editUseSSL">Use SSL</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Email Account Modal -->
        <div class="modal fade" id="deleteEmailAccountModal" tabindex="-1" aria-labelledby="deleteEmailAccountLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form method="POST" id="deleteEmailAccountForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteEmailAccountLabel">Delete Email Account</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete <strong id="deleteAccountName"></strong>?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Uploaded Files -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Processed Documents</h5>
                        <span class="badge bg-success">{{ uploaded_files|length }} files</span>
                    </div>
                    <div class="card-body">
                        {% if uploaded_files %}
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">Title</th>
                                            <th scope="col">Size</th>
                                            <th scope="col">Processed</th>
                                            <th scope="col">Pages</th>
                                            <th scope="col">Words</th>
                                            <th scope="col">Chunks</th>
                                            <th scope="col" class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for file in uploaded_files %}
                                        <tr data-uploaded-row="{{ file.name }}">
                                            <td>
                                                <div class="d-flex align-items-start">
                                                    <span class="status-indicator status-completed me-2"></span>
                                                    <div>
                                                                                                                <div class="fw-semibold d-flex align-items-center gap-2">
                                                                                                                        <a href="{{ url_for('download_file', filename=file.name) }}" class="text-decoration-none">{{ file.title or file.name }}</a>
                                                                                                                        <button class="btn btn-xs btn-outline-secondary btn-sm py-0 px-1" data-bs-toggle="modal" data-bs-target="#editDocModal-{{ file.name|replace('.', '_') }}" title="Edit title"><i class="fas fa-pen small"></i></button>
                                                                                                                </div>
                                                                                                                <div class="text-muted small">{{ file.name }}</div>
                                                                                                                {% if file.top_keywords %}
                                                                                                                        <div class="small mt-1 text-truncate" style="max-width:300px;" title="Keywords: {{ file.top_keywords|join(', ') }}">
                                                                                                                                <i class="fas fa-tags text-muted"></i>
                                                                                                                                {% for kw in file.top_keywords[:6] %}
                                                                                                                                        <span class="badge bg-light text-dark border">{{ kw }}</span>
                                                                                                                                {% endfor %}
                                                                                                                                {% if file.top_keywords|length > 6 %}<span class="badge bg-secondary">+{{ file.top_keywords|length - 6 }}</span>{% endif %}
                                                                                                                        </div>
                                                                                                                {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ "%.1f"|format(file.size / 1024 / 1024) }} MB</td>
                                                                                        <td>{{ file.modified.strftime('%Y-%m-%d %H:%M') }}</td>
                                                                                        <td>{% if file.page_count is not none %}{{ file.page_count }}{% else %}-{% endif %}</td>
                                                                                        <td>{% if file.word_count is not none %}{{ file.word_count }}{% else %}-{% endif %}</td>
                                            <td>
                                                {% if file.chunks_count is not none %}
                                                    <span class="badge bg-info text-dark">{{ file.chunks_count }}</span>
                                                {% else %}-{% endif %}
                                            </td>
                                            <td class="text-end">
                                                {% set st = file.status %}
                                                {% if st and ('deletion' in (st.message or '').lower() or 'archiving' in (st.message or '').lower() or 'removing embeddings' in (st.message or '').lower()) %}
                                                    <div class="small mb-1">{{ st.message }}</div>
                                                    <div class="progress progress-custom" style="height:6px;">
                                                        <div class="progress-bar bg-danger progress-animated uploaded-delete-progress"
                                                             role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                                             data-filename="{{ file.name }}" data-initial-progress="{{ st.progress or 0 }}"
                                                             style="width: 0%"></div>
                                                    </div>
                                                {% else %}
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <form method="POST" action="{{ url_for('delete_file_bg', folder='uploaded', filename=file.name) }}" onsubmit="return confirm('Delete this file and remove from database?')" style="display:inline;">
                                                            <button type="submit" class="btn btn-outline-danger action-btn" title="Delete">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                                                                <!-- Edit Document Modal -->
                                                                                <div class="modal fade" id="editDocModal-{{ file.name|replace('.', '_') }}" tabindex="-1" aria-hidden="true">
                                                                                    <div class="modal-dialog modal-dialog-centered">
                                                                                        <div class="modal-content">
                                                                                            <form method="POST" action="{{ url_for('update_document_metadata', filename=file.name) }}">
                                                                                                <div class="modal-header">
                                                                                                    <h5 class="modal-title">Edit Document Title</h5>
                                                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                                                </div>
                                                                                                <div class="modal-body">
                                                                                                    <div class="mb-3">
                                                                                                        <label class="form-label">Title</label>
                                                                                                        <input type="text" class="form-control" name="title" value="{{ file.title or '' }}" maxlength="160" />
                                                                                                        <div class="form-text">Update the display title. Leave unchanged to keep current.</div>
                                                                                                    </div>
                                                                                                </div>
                                                                                                <div class="modal-footer">
                                                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                                                    <button type="submit" class="btn btn-primary">Save</button>
                                                                                                </div>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-database fa-3x mb-3"></i>
                                <p>No documents processed yet. Process files from staging area.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Auto-refresh for processing status -->
    <script>
        function refreshProcessingStatus() {
            const fileCards = document.querySelectorAll('.file-card');
            fileCards.forEach(card => {
                const filename = card.querySelector('.card-title').textContent.trim();
                if (card.querySelector('.status-processing, .status-chunking, .status-embedding, .status-storing')) {
                    fetch(`/status/${encodeURIComponent(filename)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status !== 'not_found') {
                                // Update status indicator
                                const indicator = card.querySelector('.status-indicator');
                                if (indicator) {
                                    indicator.className = `status-indicator status-${data.status}`;
                                }
                                
                                // Update progress and message
                                const messageEl = card.querySelector('small');
                                if (messageEl && data.message) {
                                    messageEl.textContent = data.message;
                                }
                                
                                const progressBar = card.querySelector('.progress-bar');
                                if (progressBar && typeof data.progress === 'number') {
                                    progressBar.style.width = `${data.progress}%`;
                                    progressBar.setAttribute('aria-valuenow', String(data.progress));
                                    // Toggle animation depending on state
                                    if (["queued","processing","chunking","embedding","storing"].includes(data.status)) {
                                        progressBar.classList.add('progress-animated');
                                    } else {
                                        progressBar.classList.remove('progress-animated');
                                    }
                                }
                                
                                // If this card is in a deletion flow, remove it when done
                                if (data.message && data.message.toLowerCase().includes('deletion complete')) {
                                    card.style.transition = 'opacity 200ms ease';
                                    card.style.opacity = '0';
                                    setTimeout(() => card.remove(), 220);
                                    return;
                                }
                                // Only reload when completed/error if the user isn't typing in any input to avoid disrupting URL adds
                                if (data.status === 'completed' || data.status === 'error') {
                                    const focused = document.querySelector('input:focus, textarea:focus, select:focus, [contenteditable="true"]:focus');
                                    if (!focused) {
                                        setTimeout(() => {
                                            const stillFocused = document.querySelector('input:focus, textarea:focus, select:focus, [contenteditable="true"]:focus');
                                            if (!stillFocused) {
                                                location.reload();
                                            }
                                        }, 1000);
                                    }
                                }
                            }
                        })
                        .catch(error => console.error('Status update error:', error));
                }
            });
        }
        
        // Refresh every 2 seconds for processing files
        setInterval(refreshProcessingStatus, 2000);
        // Initialize any progress bars rendered with server-side values
        document.querySelectorAll('.progress-bar[data-initial-progress]').forEach(pb => {
            const init = parseInt(pb.getAttribute('data-initial-progress')) || 0;

                // URL refresh progress polling
                function refreshUrlStatuses() {
                    document.querySelectorAll('.progress-bar[data-url-id]').forEach(pb => {
                        const urlId = pb.getAttribute('data-url-id');
                        fetch(`/url_status/${urlId}`)
                            .then(r => r.json())
                            .then(data => {
                                if (!data) return;
                                if (data.status === 'deleted') {
                                    // Remove the entire row from the table
                                    const row = pb.closest('tr');
                                    if (row) {
                                        row.style.transition = 'opacity 200ms ease';
                                        row.style.opacity = '0';
                                        setTimeout(() => row.remove(), 220);
                                    }
                                    return;
                                }
                                if (data.status === 'not_found') {
                                    // Background task ended; swap progress for final badge without full reload
                                    try {
                                        const td = pb.closest('td');
                                        if (td) {
                                            const statusText = (data.last_update_status || '—').replaceAll('_',' ');
                                            const cls = data.last_update_status === 'updated' ? 'bg-success' : (['unchanged','no_content'].includes(data.last_update_status) ? 'bg-secondary' : 'bg-light text-dark');
                                            td.innerHTML = `<span class="badge ${cls}">${statusText.charAt(0).toUpperCase()+statusText.slice(1)}</span>`;
                                        }
                                        // Also update the Last/Next times in the adjacent column if present
                                        const row = td ? td.closest('tr') : null;
                                        if (row) {
                                            const timesCell = row.children[2];
                                            if (timesCell) {
                                                const lines = timesCell.querySelectorAll('div');
                                                if (lines && lines.length >= 3) {
                                                    // Update Last
                                                    const lastVal = data.last_scraped ? String(data.last_scraped).slice(0,16) : '—';
                                                    lines[1].textContent = `Last: ${lastVal}`;
                                                    // Update Next
                                                    const nextVal = data.next_refresh ? String(data.next_refresh).slice(0,16) : '—';
                                                    lines[2].textContent = `Next: ${nextVal}`;
                                                }
                                            }
                                        }
                                    } catch (e) { /* no-op */ }
                                    return;
                                }
                                const pct = typeof data.progress === 'number' ? data.progress : 0;
                                pb.style.width = `${pct}%`;
                                pb.setAttribute('aria-valuenow', String(pct));
                                if (["queued","processing","chunking","embedding","storing"].includes(data.status)) {
                                    pb.classList.add('progress-animated');
                                } else {
                                    pb.classList.remove('progress-animated');
                                }
                                if (data.status === 'completed' || data.status === 'error') {
                                    // Replace with badge immediately
                                    const td = pb.closest('td');
                                    if (td) {
                                        const s = data.status === 'completed' ? 'updated' : 'error';
                                        const cls = s === 'updated' ? 'bg-success' : 'bg-light text-dark';
                                        td.innerHTML = `<span class="badge ${cls}">${s.charAt(0).toUpperCase()+s.slice(1)}</span>`;
                                    }
                                }
                            })
                            .catch(() => {});
                    });
                }
                setInterval(refreshUrlStatuses, 1500);
                // Initialize URL bars
                refreshUrlStatuses();

                function refreshEmailStatuses() {
                    document.querySelectorAll('.progress-bar[data-email-id]').forEach(pb => {
                        const acctId = pb.getAttribute('data-email-id');
                        fetch(`/email_status/${acctId}`)
                            .then(r => r.json())
                            .then(data => {
                                if (!data) return;
                                if (data.status === 'deleted') {
                                    const row = pb.closest('tr');
                                    if (row) {
                                        row.style.transition = 'opacity 200ms ease';
                                        row.style.opacity = '0';
                                        setTimeout(() => row.remove(), 220);
                                    }
                                    return;
                                }
                                if (data.status === 'not_found') {
                                    try {
                                        const td = pb.closest('td');
                                        if (td) {
                                            const statusText = data.last_update_status || '—';
                                            const cls = statusText.startsWith('error') ? 'bg-light text-dark' : 'bg-success';
                                            td.innerHTML = `<span class="badge ${cls}">${statusText}</span>`;
                                        }
                                        const row = td ? td.closest('tr') : null;
                                        if (row) {
                                            const timesCell = row.children[4];
                                            if (timesCell) {
                                                const lines = timesCell.querySelectorAll('div');
                                                if (lines && lines.length >= 3) {
                                                    const lastVal = data.last_synced ? String(data.last_synced).slice(0,16) : '—';
                                                    lines[1].textContent = `Last: ${lastVal}`;
                                                    const nextVal = data.next_run ? String(data.next_run).slice(0,16) : '—';
                                                    lines[2].textContent = `Next: ${nextVal}`;
                                                }
                                            }
                                        }
                                    } catch (e) { /* no-op */ }
                                    return;
                                }
                                const pct = typeof data.progress === 'number' ? data.progress : 0;
                                pb.style.width = `${pct}%`;
                                pb.setAttribute('aria-valuenow', String(pct));
                                if (["queued","processing","chunking","embedding","storing"].includes(data.status)) {
                                    pb.classList.add('progress-animated');
                                } else {
                                    pb.classList.remove('progress-animated');
                                }
                                if (data.status === 'completed' || data.status === 'error') {
                                    const td = pb.closest('td');
                                    if (td) {
                                        const s = data.status === 'completed' ? (data.last_update_status || 'updated') : `error`;
                                        const cls = s.startsWith('error') ? 'bg-light text-dark' : 'bg-success';
                                        td.innerHTML = `<span class="badge ${cls}">${s}</span>`;
                                    }
                                }
                            })
                            .catch(() => {});
                    });
                }
                setInterval(refreshEmailStatuses, 1500);
                refreshEmailStatuses();
            pb.style.width = `${init}%`;
            pb.setAttribute('aria-valuenow', String(init));
            if (init >= 100) {
                pb.classList.remove('progress-animated');
            }
        });
    </script>
        <script>
            // Poll for deletion progress of uploaded files
            function pollUploadedDeletion() {
                document.querySelectorAll('.uploaded-delete-progress').forEach(pb => {
                    const filename = pb.getAttribute('data-filename');
                            // Lazy initialize width animation
                            if (pb.dataset.initialized !== '1') {
                                const init = parseInt(pb.getAttribute('data-initial-progress')||'0',10);
                                pb.style.width = init + '%';
                                pb.setAttribute('aria-valuenow', String(init));
                                pb.dataset.initialized = '1';
                            }
                    fetch(`/status/${encodeURIComponent(filename)}`)
                        .then(r=>r.json())
                        .then(data => {
                            if(!data) return;
                            if(typeof data.progress === 'number') {
                                pb.style.width = data.progress + '%';
                                pb.setAttribute('aria-valuenow', String(data.progress));
                            }
                            if (data.message) {
                                const msgDiv = pb.closest('td').querySelector('.small.mb-1');
                                if (msgDiv) msgDiv.textContent = data.message;
                            }
                            if (data.status === 'completed' && (data.message||'').toLowerCase().includes('deletion complete')) {
                                const row = pb.closest('tr[data-uploaded-row]');
                                if (row) {
                                    row.style.transition = 'opacity 200ms ease';
                                    row.style.opacity = '0';
                                    setTimeout(()=> row.remove(), 220);
                                }
                            }
                        }).catch(()=>{});
                });
            }
            setInterval(pollUploadedDeletion, 1200);
        </script>
        <script>
            // Populate edit email account modal with existing data
            document.querySelectorAll('.edit-account-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const form = document.getElementById('editEmailAccountForm');
                    form.action = btn.dataset.action;
                    document.getElementById('editAccountId').value = btn.dataset.id || '';
                    document.getElementById('editAccountName').value = btn.dataset.name || '';
                    document.getElementById('editServer').value = btn.dataset.server || '';
                    document.getElementById('editEmailAddress').value = btn.dataset.email || '';
                    document.getElementById('editPassword').value = '';
                    document.getElementById('editPort').value = btn.dataset.port || '';
                    document.getElementById('editMailbox').value = btn.dataset.mailbox || '';
                    document.getElementById('editBatchLimit').value = btn.dataset.batch || '';
                    document.getElementById('editRefreshInterval').value = btn.dataset.interval || '';
                    document.getElementById('editUseSSL').checked = ['1','true','on'].includes(btn.dataset.ssl);
                    document.getElementById('editServerType').value = btn.dataset.type || 'imap';
                });
            });
            // Populate delete confirmation modal
            document.querySelectorAll('.delete-account-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const form = document.getElementById('deleteEmailAccountForm');
                    form.action = btn.dataset.action;
                    document.getElementById('deleteAccountName').textContent = btn.dataset.name || '';
                });
            });
        </script>
</body>
</html>
