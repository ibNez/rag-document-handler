<!-- URL Management Section -->
<div id="url-management" class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-link me-2"></i>URL Management</h5>
            </div>
            <div class="card-body">
                <!-- Add URL Form -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <form method="POST" action="{{ url_for('add_url') }}">
                            <div class="input-group">
                                <input type="url" name="url" class="form-control" 
                                       placeholder="Enter URL (e.g., https://example.com)" required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i>Add URL
                                </button>
                            </div>
                        </form>
                        <div class="form-text">
                            Add URLs to keep track of important resources. The title will be automatically extracted from the page.
                        </div>
                    </div>
                </div>
                
                <!-- URL List -->
                <div id="urlList">
                    {% if urls %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40%">URL</th>
                                        <th style="width: 20%">Robots & Crawl</th>
                                        <th class="schedule-times">Schedule / Times</th>
                                        <th style="width: 8%" class="text-center">Pages</th>
                                        <th style="width: 8%" class="text-center">Chunks</th>
                                        <th style="width: 10%" class="text-center">Size</th>
                                        <th style="width: 8%">Status</th>
                                        <th style="width: 10%" class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for url in urls %}
                                    <tr data-url-row="{{ url.url_id }}">
                                        <td>
                                            <div class="d-flex flex-column">
                                                <div class="d-flex align-items-center">
                                                    <a href="{{ url.url }}" target="_blank" class="text-decoration-none fw-semibold text-truncate" style="max-width: 520px;" title="{{ url.title or url.url }}">
                                                        {{ url.title if url.title else url.url.split('://')[1].split('/')[0] }}
                                                        <i class="fas fa-external-link-alt ms-1 text-muted small"></i>
                                                    </a>
                                                </div>
                                                <div class="text-muted small text-truncate" style="max-width: 520px;" title="{{ url.url }}">{{ url.url }}</div>
                                                {% if url.description %}
                                                    <div class="text-secondary small text-truncate" style="max-width: 520px;" title="{{ url.description }}">{{ url.description }}</div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="small">
                                                <span class="badge rounded-pill {{ 'bg-info' if url.crawl_domain else 'bg-secondary' }}">Crawl {{ 'On' if url.crawl_domain else 'Off' }}</span>
                                                {% if url.ignore_robots %}
                                                    <span class="badge rounded-pill bg-warning text-dark ms-1" title="Robots.txt checks will be skipped for this URL">Robots Ignored</span>
                                                {% endif %}
                                                {% if url.robots_allowed is not none %}
                                                    {% if url.robots_allowed %}
                                                        <span class="badge rounded-pill bg-success ms-1" title="robots.txt allows fetching this URL">Allowed</span>
                                                    {% else %}
                                                        <span class="badge rounded-pill bg-danger ms-1" title="robots.txt disallows fetching this URL">Disallowed</span>
                                                    {% endif %}
                                                    {% if url.robots_has_rules %}
                                                        <span class="badge rounded-pill bg-secondary ms-1" title="robots.txt has specific rules or a crawl-delay for this site">Has Rules</span>
                                                    {% endif %}
                                                    {% if url.robots_crawl_delay is not none %}
                                                        <span class="badge rounded-pill bg-secondary ms-1" title="Crawl-delay from robots.txt">Delay {{ '%.1f'|format(url.robots_crawl_delay) }}s</span>
                                                    {% endif %}
                                                {% endif %}
                                                <span class="badge rounded-pill bg-primary ms-1" title="Snapshots always enabled"><i class="fas fa-camera me-1"></i>Snapshots</span>
                                                {% if url.snapshot_retention_days is not none and url.snapshot_retention_days > 0 %}
                                                    <span class="badge rounded-pill bg-light text-dark ms-1" title="Retention days">{{ url.snapshot_retention_days }}d</span>
                                                {% elif url.snapshot_retention_days == 0 %}
                                                    <span class="badge rounded-pill bg-light text-dark ms-1" title="Retention days">∞d</span>
                                                {% endif %}
                                                {% if url.snapshot_max_snapshots is not none and url.snapshot_max_snapshots > 0 %}
                                                    <span class="badge rounded-pill bg-light text-dark ms-1" title="Max snapshots">{{ url.snapshot_max_snapshots }} max</span>
                                                {% elif url.snapshot_max_snapshots == 0 %}
                                                    <span class="badge rounded-pill bg-light text-dark ms-1" title="Max snapshots">∞ max</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="small schedule-times">
                                            <div>Every {{ url.refresh_interval_minutes or 1440 }} min</div>
                                            <div class="text-muted">Last: <span class="dt-local" data-utc="{{ url.last_scraped or '' }}">{{ url.last_scraped or '—' }}</span></div>
                                            <div class="text-muted">Next: <span class="dt-local" data-utc="{{ url.next_refresh or '' }}">{{ url.next_refresh or '—' }}</span></div>
                                        </td>
                                        <td class="text-center">
                                            {% if url.has_children %}
                                                <div>{{ url.child_stats.total_children }}</div>
                                                <div class="small text-muted">children</div>
                                            {% else %}
                                                {{ url.pages if url.pages is not none else '—' }}
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {{ url.chunk_count or 0 }}
                                        </td>
                                        <td class="text-center">
                                            {% if url.snapshot_total_size is not none %}
                                                {{ url.snapshot_total_size }}
                                            {% elif url.snapshot_count is not none %}
                                                {{ url.snapshot_count }} files
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set up = url_processing_status.get(url.url_id) if url_processing_status else None %}
                                            {% if up %}
                                                <div class="small mb-1">
                                                    <span class="badge bg-info" title="{{ up.message }}">{{ up.status.title() }}</span>
                                                </div>
                                                <div class="progress progress-custom">
                                          <div class="progress-bar bg-success progress-animated"
                                              role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                              data-url-id="{{ url.url_id }}"
                                                         data-initial-progress="{{ up.progress or 0 }}"
                                                         style="width: 0%"></div>
                                                </div>
                                            {% elif url.has_children and url.is_parent_with_active_children %}
                                                <div class="small mb-1">
                                                    <span class="badge bg-warning child-status-badge" title="Child URLs are being processed">Children Processing</span>
                                                </div>
                                                <div class="progress child-progress mb-1">
                                                    <div class="progress-bar"
                                                         role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                                         style="width: {{ url.child_progress_percent }}%"
                                                         title="Child URL Progress: {{ url.child_stats.completed_children }}/{{ url.child_stats.total_children }} completed"></div>
                                                </div>
                                                <div class="child-stats-text text-muted">
                                                    {{ url.child_stats.completed_children }}/{{ url.child_stats.total_children }} children
                                                    {% if url.child_stats.processing_children > 0 %}
                                                        ({{ url.child_stats.processing_children }} active)
                                                    {% endif %}
                                                    {% if url.child_stats.failed_children > 0 %}
                                                        <span class="text-danger">({{ url.child_stats.failed_children }} failed)</span>
                                                    {% endif %}
                                                </div>
                                            {% elif url.has_children %}
                                                <div class="small mb-1">
                                                    <span class="badge bg-secondary child-status-badge" title="All child URLs completed">Children Complete</span>
                                                </div>
                                                <div class="child-stats-text text-muted">
                                                    {{ url.child_stats.total_children }} children
                                                    {% if url.child_stats.failed_children > 0 %}
                                                        <span class="text-danger">({{ url.child_stats.failed_children }} failed)</span>
                                                    {% endif %}
                                                </div>
                                            {% elif url.last_update_status %}
                                                <span class="badge {% if url.last_update_status == 'updated' %}bg-success{% elif url.last_update_status in ['unchanged','no_content'] %}bg-secondary{% else %}bg-light text-dark{% endif %}">
                                                    {{ url.last_update_status.replace('_', ' ').title() }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted small">—</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary action-btn" data-bs-toggle="modal" data-bs-target="#editUrlModal-{{ url.url_id }}" title="Edit">
                                                    <i class="fas fa-pen"></i>
                                                </button>
                                                <form method="POST" action="{{ url_for('ingest_url', url_id=url.url_id) }}">
                                                    <button type="submit" class="btn btn-outline-primary action-btn" title="Refresh now">
                                                        <i class="fas fa-sync"></i>
                                                    </button>
                                                </form>
                                                <form method="POST" action="{{ url_for('delete_url_bg', url_id=url.url_id) }}" onsubmit="return confirm('Are you sure you want to delete this URL and its embeddings?')">
                                                    <button type="submit" class="btn btn-outline-danger action-btn" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-link fa-3x mb-3"></i>
                            <p>No URLs added yet. Add your first URL above.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
