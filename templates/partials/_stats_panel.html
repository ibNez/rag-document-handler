<!-- Statistics Panel - System Status and Data Overview -->
<div id="knowledgebase-stats" class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <!-- Metrics styles moved to static/style.css -->
                <div class="row g-3">
                    <div class="col-12 col-lg-6">
                        <div class="kb-section-title">Connections</div>
                        <div class="metric-grid">
                            <div class="metric-tile">
                                <div class="metric-label">SQL</div>
                                <div class="metric-value">
                                    <span class="status-dot {{ 'dot-ok' if sql_status and sql_status.connected else 'dot-bad' }}"></span>
                                    {{ 'Connected' if sql_status and sql_status.connected else 'Unavailable' }}
                                </div>
                                {% if sql_status and sql_status.connected and sql_status.version %}
                                    <div class="metric-sub">v{{ sql_status.version }}</div>
                                {% endif %}
                            </div>
                            <div class="metric-tile">
                                <div class="metric-label">Milvus</div>
                                <div class="metric-value d-flex align-items-center">
                                    <span class="status-dot {{ 'dot-ok' if milvus_status and milvus_status.connected else 'dot-bad' }}"></span>
                                    <span>{{ 'Connected' if milvus_status and milvus_status.connected else 'Unavailable' }}</span>
                                </div>
                                {% if milvus_status and milvus_status.connected and milvus_status.version %}
                                    <div class="metric-sub">v{{ milvus_status.version }}</div>
                                {% endif %}
                            </div>
                            <div class="metric-tile">
                                <div class="metric-label">Collection</div>
                                <div class="metric-value">{{ collection_stats.name }}</div>
                                <div class="metric-sub">{{ collection_stats.num_entities or 0 }} entities</div>
                            </div>
                            <div class="metric-tile">
                                <div class="metric-label">Collection</div>
                                <div class="metric-value">{{ email_collection_stats.name if email_collection_stats else 'emails' }}</div>
                                <div class="metric-sub">{{ email_collection_stats.num_entities if email_collection_stats else (email_meta.total_emails or 0) }} entities</div>
                            </div>
                            <div class="metric-tile">
                                <div class="metric-label">Ollama Chat</div>
                                <div class="metric-value">
                                    <span class="status-dot {{ 'dot-ok' if ollama_status.services.chat.connected and ollama_status.services.chat.model_loaded else 'dot-bad' }}"></span>
                                    {{ 'Connected' if ollama_status.services.chat.connected and ollama_status.services.chat.model_loaded else 'Unavailable' }}
                                </div>
                                {% if ollama_status.services.chat.connected %}
                                    <div class="metric-sub">{{ ollama_status.services.chat.model_name }}</div>
                                {% elif ollama_status.services.chat.error_message %}
                                    <div class="metric-sub text-warning">{{ ollama_status.services.chat.error_message[:30] }}...</div>
                                {% endif %}
                            </div>
                            <div class="metric-tile">
                                <div class="metric-label">Ollama Embed</div>
                                <div class="metric-value">
                                    <span class="status-dot {{ 'dot-ok' if ollama_status.services.embedding.connected and ollama_status.services.embedding.model_loaded else 'dot-bad' }}"></span>
                                    {{ 'Connected' if ollama_status.services.embedding.connected and ollama_status.services.embedding.model_loaded else 'Unavailable' }}
                                </div>
                                {% if ollama_status.services.embedding.connected %}
                                    <div class="metric-sub">{{ ollama_status.services.embedding.model_name }}</div>
                                {% elif ollama_status.services.embedding.error_message %}
                                    <div class="metric-sub text-warning">{{ ollama_status.services.embedding.error_message[:30] }}...</div>
                                {% endif %}
                            </div>
                            <div class="metric-tile">
                                <div class="metric-label">Ollama Class</div>
                                <div class="metric-value">
                                    <span class="status-dot {{ 'dot-ok' if ollama_status.services.classification.connected and ollama_status.services.classification.model_loaded else 'dot-bad' }}"></span>
                                    {{ 'Connected' if ollama_status.services.classification.connected and ollama_status.services.classification.model_loaded else 'Unavailable' }}
                                </div>
                                {% if ollama_status.services.classification.connected %}
                                    <div class="metric-sub">{{ ollama_status.services.classification.model_name }}</div>
                                {% elif ollama_status.services.classification.error_message %}
                                    <div class="metric-sub text-warning">{{ ollama_status.services.classification.error_message[:30] }}...</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="kb-section-title">Documents</div>
                        <div class="metric-grid">
                            <div class="metric-tile"><div class="metric-label">Total Docs</div><div class="metric-value">{{ kb_meta.documents_total }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Avg Words/Doc</div><div class="metric-value">{{ kb_meta.avg_words_per_doc }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Avg Chunks/Doc</div><div class="metric-value">{{ kb_meta.avg_chunks_per_doc }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Median Chunk Chars</div><div class="metric-value">{{ kb_meta.median_chunk_chars }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Embedding Dim</div><div class="metric-value">{{ collection_stats.dim or (config.VECTOR_DIM if config else '') }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Index</div><div class="metric-value">{{ 'Yes' if collection_stats.indexed else 'No' }}</div><div class="metric-sub">Metric {{ collection_stats.metric_type or 'cosine' }}</div></div>
                        </div>
                        {% if kb_meta.top_keywords %}
                        <div class="kb-section-title mt-3">Top Keywords</div>
                        <div class="keywords-wrap">
                            {% for k in kb_meta.top_keywords %}
                                <span class="keyword-pill">{{ k }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="kb-section-title">URLs</div>
                        <div class="metric-grid">
                            <div class="metric-tile"><div class="metric-label">Total URLs</div><div class="metric-value">{{ url_meta.total or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Sub-URLs</div><div class="metric-value">{{ url_meta.sub_urls or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Crawl Domain On</div><div class="metric-value">{{ url_meta.crawl_on or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Robots Ignored</div><div class="metric-value">{{ url_meta.robots_ignored or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Scraped</div><div class="metric-value">{{ url_meta.scraped or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Due Now</div><div class="metric-value">{{ url_meta.due_now or 0 }}</div></div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="kb-section-title">Emails</div>
                        <div class="metric-grid">
                            <div class="metric-tile"><div class="metric-label">Total Accounts</div><div class="metric-value">{{ email_meta.total_accounts or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Due Now</div><div class="metric-value">{{ email_meta.due_now or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Never Synced</div><div class="metric-value">{{ email_meta.never_synced or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Total Emails</div><div class="metric-value">{{ email_meta.total_emails or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">With Attachments</div><div class="metric-value">{{ email_meta.emails_with_attachments or 0 }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Embedding Dim</div><div class="metric-value">{{ email_collection_stats.dim if email_collection_stats else '' }}</div></div>
                            <div class="metric-tile"><div class="metric-label">Index</div><div class="metric-value">{{ 'Yes' if email_collection_stats and email_collection_stats.indexed else 'No' }}</div><div class="metric-sub">Metric {{ email_collection_stats.metric_type if email_collection_stats and email_collection_stats.metric_type else 'cosine' }}</div></div>
                            {% if email_meta.avg_emails_per_account > 0 %}
                            <div class="metric-tile"><div class="metric-label">Avg per Account</div><div class="metric-value">{{ email_meta.avg_emails_per_account }}</div></div>
                            {% endif %}
                        </div>
                        {% if email_meta.most_active_account %}
                        <div class="kb-section-title mt-3">Most Active Account</div>
                        <div class="keywords-wrap">
                            <span class="keyword-pill">{{ email_meta.most_active_account }}</span>
                        </div>
                        {% endif %}
                        {% if email_meta.latest_email_date %}
                        <div class="kb-section-title mt-3">Latest Email</div>
                        <div class="metric-sub"><span class="dt-local" data-utc="{{ email_meta.latest_email_date or '' }}">{{ email_meta.latest_email_date or 'â€”' }}</span></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
